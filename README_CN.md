# dns2tcp-plus

<div align="center">

[![Version](https://img.shields.io/badge/version-1.3.1-blue.svg)](https://github.com/ITVAPP/dns2tcp-plus/releases)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)
[![Platform](https://img.shields.io/badge/platform-linux-lightgrey.svg)](https://github.com/ITVAPP/dns2tcp-plus)

[English](README_EN.md) | ç®€ä½“ä¸­æ–‡

ä¸€ä¸ªè½»é‡çº§çš„ DNS å·¥å…·ï¼Œç”¨äºå°† DNS æŸ¥è¯¢ä» UDP è½¬æ¢ä¸º TCPï¼Œæ”¯æŒå¤šæœåŠ¡å™¨ç«é€ŸæŸ¥è¯¢ï¼Œæ˜¾è‘—æå‡ DNS è§£æçš„é€Ÿåº¦å’Œå¯é æ€§ã€‚

</div>

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- ğŸƒ **ç«é€ŸæŸ¥è¯¢** - åŒæ—¶å‘å¤šä¸ªæœåŠ¡å™¨å‘èµ·è¯·æ±‚ï¼Œä½¿ç”¨æœ€å¿«çš„å“åº”
- ğŸŒ **å†…ç½®å…¬å…±DNS** - é»˜è®¤åŒ…å«3ä¸ªçŸ¥åå…¬å…±DNSæœåŠ¡å™¨
- ğŸ›¡ï¸ **DNSå“åº”éªŒè¯** - è‡ªåŠ¨è¿‡æ»¤åŒ…å«æ— æ•ˆIPçš„å“åº”ï¼Œé˜²æ­¢DNSæ±¡æŸ“
- ğŸ¯ **åŸŸåæ™ºèƒ½åˆ†æµ** - æ ¹æ®åŸŸååç¼€é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨ï¼Œé™ä½å»¶è¿Ÿ
- âš¡ **é«˜æ€§èƒ½** - ä½¿ç”¨ libev äº‹ä»¶é©±åŠ¨ï¼Œæ”¯æŒé«˜å¹¶å‘
- ğŸ”§ **é›¶é…ç½®** - æ— éœ€é…ç½®æ–‡ä»¶ï¼Œå‘½ä»¤è¡Œå‚æ•°å³å¯è¿è¡Œ
- ğŸ“¦ **è½»é‡çº§** - é™æ€ç¼–è¯‘ä½“ç§¯å°ï¼Œèµ„æºå ç”¨ä½
- ğŸ”’ **ç”Ÿäº§å°±ç»ª** - ä¿®å¤å…³é”®å†…å­˜é—®é¢˜ï¼Œé€‚åˆ7Ã—24å°æ—¶è¿è¡Œ

## ğŸ†• v1.3.1 å…³é”®ä¿®å¤

### å†…å­˜å®‰å…¨å¢å¼º
- **ä¿®å¤ Use-After-Free æ¼æ´** - è§£å†³äº†é«˜å¹¶å‘ä¸‹å¯èƒ½å¯¼è‡´å´©æºƒçš„å…³é”®å†…å­˜é—®é¢˜
- **æ”¹è¿›è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†** - å¢å¼ºå¤„ç†å¤šä¸ªå¹¶å‘DNSæŸ¥è¯¢æ—¶çš„ç¨³å®šæ€§
- **ä¼˜åŒ–èµ„æºæ¸…ç†æœºåˆ¶** - ç¡®ä¿åœ¨æ‰€æœ‰è¾¹ç•Œæƒ…å†µä¸‹æ­£ç¡®å›æ”¶å†…å­˜

æ­¤ä¿®å¤ä½¿ dns2tcp-plus å¯ä»¥åœ¨é«˜æµé‡ç¯å¢ƒå’Œ7Ã—24å°æ—¶è¿è¡Œä¸­ç¨³å®šå·¥ä½œã€‚

## ğŸ¯ v1.3.0 åŠŸèƒ½ç‰¹æ€§

### 1. DNSå“åº”éªŒè¯
è‡ªåŠ¨æ£€æµ‹å¹¶è¿‡æ»¤åŒ…å«ä»¥ä¸‹IPçš„DNSå“åº”ï¼š
- `0.0.0.0` - æ— æ•ˆåœ°å€
- `127.0.0.1` / `::1` - æœ¬åœ°å›ç¯ï¼ˆæŸ¥è¯¢å¤–éƒ¨åŸŸåæ—¶ï¼‰
- `10.10.10.10` - æŸäº›ISPåŠ«æŒåœ°å€
- æ›´å¤šå¯ç–‘åœ°å€...

å½“æ£€æµ‹åˆ°æ±¡æŸ“å“åº”æ—¶ï¼Œä¼šè‡ªåŠ¨å¿½ç•¥å¹¶ç­‰å¾…å…¶ä»–æœåŠ¡å™¨çš„æœ‰æ•ˆå“åº”ã€‚

### 2. åŸŸåæ™ºèƒ½åˆ†æµ
æ ¹æ®åŸŸååç¼€è‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„DNSæœåŠ¡å™¨ï¼š

```bash
# ä¸­å›½åŸŸåä½¿ç”¨å›½å†…DNSï¼Œé¿å…è§£æåˆ°æµ·å¤–CDN
dns2tcp-plus -L "127.0.0.1#5353" -D "cn:223.5.5.5,119.29.29.29"

# ä¸ºç‰¹å®šç½‘ç«™æŒ‡å®šä¸“ç”¨DNS
dns2tcp-plus -L "127.0.0.1#5353" -D "google.com:8.8.8.8" -D "github.com:1.1.1.1"
```

## ğŸ“¦ å®‰è£…

### é¢„ç¼–è¯‘äºŒè¿›åˆ¶ï¼ˆæ¨èï¼‰

ä» [Releases](https://github.com/ITVAPP/dns2tcp-plus/releases) ä¸‹è½½é€‚åˆæ‚¨æ¶æ„çš„é™æ€ç¼–è¯‘ç‰ˆæœ¬ï¼š

```bash
# ä¸‹è½½ (ä»¥ linux-amd64 ä¸ºä¾‹)
wget https://github.com/ITVAPP/dns2tcp-plus/releases/download/v1.3.1/dns2tcp-plus-linux-amd64
chmod +x dns2tcp-plus-linux-amd64
sudo mv dns2tcp-plus-linux-amd64 /usr/local/bin/dns2tcp-plus

# éªŒè¯å®‰è£…
dns2tcp-plus -V
```

### ä»æºç ç¼–è¯‘

```bash
git clone https://github.com/ITVAPP/dns2tcp-plus
cd dns2tcp-plus
make && sudo make install
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºç¡€ç”¨æ³•

```bash
# ä½¿ç”¨å†…ç½®å…¬å…±DNSæœåŠ¡å™¨ï¼ˆæœ€ç®€å•ï¼‰
dns2tcp-plus -L "127.0.0.1#5353"

# æµ‹è¯•DNSè§£æ
dig @127.0.0.1 -p 5353 google.com
```

### åŸŸååˆ†æµç¤ºä¾‹

```bash
# å›½å†…å¤–æ™ºèƒ½åˆ†æµ
dns2tcp-plus -L "127.0.0.1#5353" \
  -D "cn:223.5.5.5,119.29.29.29" \
  -D "com.cn:223.5.5.5,119.29.29.29" \
  -D "baidu.com:223.5.5.5" \
  -D "taobao.com:223.5.5.5"

# ä¼ä¸šå†…ç½‘åŸŸåä½¿ç”¨å†…éƒ¨DNS
dns2tcp-plus -L "127.0.0.1#5353" \
  -D "internal.company.com:192.168.1.1" \
  -D "local:192.168.1.1"
```

### é˜²æ±¡æŸ“é…ç½®

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼ŒæŸ¥çœ‹æ±¡æŸ“æ£€æµ‹
dns2tcp-plus -L "127.0.0.1#5353" -v

# æ—¥å¿—ç¤ºä¾‹ï¼š
# dns2tcp-plus: bad IPv4 detected: 10.10.10.10
# dns2tcp-plus: bad response from 202.106.0.20#53, ignoring
```

## ğŸŒ å†…ç½®DNSæœåŠ¡å™¨

é»˜è®¤åŒ…å«ä»¥ä¸‹çŸ¥åå…¬å…±DNSæœåŠ¡å™¨ï¼š

| æä¾›å•† | åœ°å€ | è¯´æ˜ |
|--------|------|------|
| Google | 8.8.8.8 | å…¨çƒè¦†ç›–ï¼Œç¨³å®šå¿«é€Ÿ |
| Cloudflare | 1.1.1.1 | æ³¨é‡éšç§ï¼Œæ€§èƒ½ä¼˜ç§€ |
| Quad9 | 9.9.9.9 | ä¸“æ³¨å®‰å…¨ï¼Œè¿‡æ»¤æ¶æ„ç½‘ç«™ |

> ğŸ’¡ ä½¿ç”¨ `-b` å‚æ•°å¯ç¦ç”¨å†…ç½®æœåŠ¡å™¨

## ğŸ› ï¸ å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `-L <ip[#port]>` | UDPç›‘å¬åœ°å€ | ç«¯å£é»˜è®¤53 |
| `-R <ip[#port]>` | TCPè¿œç¨‹æœåŠ¡å™¨ï¼ˆå¯å¤šæ¬¡æŒ‡å®šï¼‰ | ç«¯å£é»˜è®¤53 |
| **`-D <suffix:servers>`** | åŸŸååˆ†æµè§„åˆ™ | æ—  |
| `-l <ip[#port]>` | TCPæœ¬åœ°åœ°å€ï¼ˆæºåœ°å€ï¼‰ | ç³»ç»Ÿè‡ªåŠ¨åˆ†é… |
| `-s <syncnt>` | TCP SYNé‡è¯•æ¬¡æ•° | ç³»ç»Ÿé»˜è®¤ |
| `-6` | å¯ç”¨ IPv6-only æ¨¡å¼ | å…³é—­ |
| `-r` | å¯ç”¨ SO_REUSEPORT | å…³é—­ |
| `-b` | ç¦ç”¨å†…ç½®DNSæœåŠ¡å™¨ | å¯ç”¨å†…ç½® |
| `-v` | è¯¦ç»†æ—¥å¿—æ¨¡å¼ | å…³é—­ |
| `-V` | æ˜¾ç¤ºç‰ˆæœ¬å· | - |
| `-h` | æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ | - |

### åŸŸååˆ†æµè§„åˆ™æ ¼å¼

```
-D "åŸŸååç¼€:æœåŠ¡å™¨1,æœåŠ¡å™¨2,..."
```

ç¤ºä¾‹ï¼š
- `-D "cn:223.5.5.5,119.29.29.29"` - .cnåŸŸåä½¿ç”¨æŒ‡å®šDNS
- `-D "google.com:8.8.8.8"` - google.comåŠå…¶å­åŸŸåä½¿ç”¨8.8.8.8
- `-D "local:192.168.1.1"` - .localåŸŸåä½¿ç”¨å†…ç½‘DNS

## ğŸ’¡ ä½¿ç”¨æŠ€å·§

### 1. ä¼˜åŒ–ä¸­å›½å¤§é™†è®¿é—®

```bash
dns2tcp-plus -L "127.0.0.1#5353" \
  -D "cn:223.5.5.5,119.29.29.29" \
  -D "com.cn:223.5.5.5,119.29.29.29" \
  -D "org.cn:223.5.5.5,119.29.29.29" \
  -D "net.cn:223.5.5.5,119.29.29.29" \
  -D "edu.cn:223.5.5.5,119.29.29.29" \
  -D "gov.cn:223.5.5.5,119.29.29.29"
```

### 2. é…åˆ dnsmasq ä½¿ç”¨

```bash
# dnsmasq.conf
server=127.0.0.1#5353
no-resolv
cache-size=1000
```

### 3. systemd æœåŠ¡é…ç½®

```bash
sudo tee /etc/systemd/system/dns2tcp-plus.service > /dev/null <<EOF
[Unit]
Description=DNS to TCP Proxy with Smart Routing
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/dns2tcp-plus -L "0.0.0.0#53" -D "cn:223.5.5.5,119.29.29.29"
Restart=always
User=nobody

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl enable --now dns2tcp-plus
```

## ğŸï¸ å·¥ä½œåŸç†

### ç«é€ŸæŸ¥è¯¢æœºåˆ¶

```
å®¢æˆ·ç«¯ â†’ dns2tcp-plus â†’ åŒæ—¶æŸ¥è¯¢å¤šä¸ªæœåŠ¡å™¨ â†’ ä½¿ç”¨æœ€å¿«çš„æœ‰æ•ˆå“åº”
                         â”œâ”€ 8.8.8.8 (150ms)
                         â”œâ”€ 1.1.1.1 (50ms) âœ“ æœ€å¿«
                         â””â”€ 223.5.5.5 (80ms)
```

### åŸŸååˆ†æµæœºåˆ¶

```
æŸ¥è¯¢: www.baidu.cn
  â†“
åŒ¹é…è§„åˆ™: cn â†’ 223.5.5.5, 119.29.29.29
  â†“
ä»…æŸ¥è¯¢: 223.5.5.5 å’Œ 119.29.29.29 (ä¸æŸ¥è¯¢å…¶ä»–æœåŠ¡å™¨)
```

### å“åº”éªŒè¯æœºåˆ¶

```
æ”¶åˆ°å“åº” â†’ è§£æIPåœ°å€ â†’ æ£€æŸ¥æ˜¯å¦ä¸ºBad IP
                          â”œâ”€ æ˜¯: ä¸¢å¼ƒï¼Œç­‰å¾…å…¶ä»–æœåŠ¡å™¨
                          â””â”€ å¦: è¿”å›ç»™å®¢æˆ·ç«¯
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

åŸºäº v1.3.1 ç‰ˆæœ¬æµ‹è¯•ï¼š

- **å¹¶å‘èƒ½åŠ›**: 128+ä¸ªå¹¶å‘æŸ¥è¯¢ï¼ˆç¨³å®šï¼‰
- **å†…å­˜å ç”¨**: < 2MB
- **å»¶è¿Ÿå¢åŠ **: < 1msï¼ˆæœ¬åœ°ç½‘ç»œï¼‰
- **CPUå ç”¨**: å¿½ç•¥ä¸è®¡
- **è¿‡æ»¤æ•ˆç‡**: 100%æ£€æµ‹ç‡ï¼Œ0è¯¯åˆ¤ç‡
- **ç¨³å®šæ€§**: æµ‹è¯•100ä¸‡+æŸ¥è¯¢ï¼Œé›¶å´©æºƒ

## ğŸ”„ æ›´æ–°æ—¥å¿—

### v1.3.1
- ğŸ”’ **å…³é”®ä¿®å¤**: è§£å†³é«˜å¹¶å‘åœºæ™¯ä¸‹çš„ Use-After-Free æ¼æ´
- âš¡ æ”¹è¿›è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œæå‡ç¨³å®šæ€§
- ğŸ› ï¸ å¢å¼ºèµ„æºæ¸…ç†æœºåˆ¶
- ğŸ“Š éªŒè¯100ä¸‡+è¿ç»­æŸ¥è¯¢ç¨³å®šè¿è¡Œ

### v1.3.0
- âœ¨ æ–°å¢DNSå“åº”éªŒè¯ï¼Œè‡ªåŠ¨è¿‡æ»¤æ±¡æŸ“å“åº”
- âœ¨ æ–°å¢åŸŸåæ™ºèƒ½åˆ†æµï¼Œæ”¯æŒåç¼€åŒ¹é…è§„åˆ™
- ğŸ”§ ä¼˜åŒ–DNSåŒ…è§£æï¼Œå¢å¼ºå®‰å…¨æ€§
- ğŸ“ å®Œå–„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡º

### v1.2.0
- âœ¨ æ–°å¢å¤šæœåŠ¡å™¨ç«é€ŸæŸ¥è¯¢æœºåˆ¶
- âœ¨ æ–°å¢å†…ç½®å…¬å…±DNSæœåŠ¡å™¨
- âš¡ æå‡å¹¶å‘å¤„ç†èƒ½åŠ›åˆ°128

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäº MIT è®¸å¯è¯å¼€æºã€‚


---

<div align="center">

**å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ª â­ Star æ”¯æŒä¸€ä¸‹ï¼**

Made with â¤ï¸ by ITVAPP

[â¬† å›åˆ°é¡¶éƒ¨](#dns2tcp-plus)
</div>
