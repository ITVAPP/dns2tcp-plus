name: Cross Compile dns2tcp-plus

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'è¾“å…¥ç‰ˆæœ¬å·, ä¾‹å¦‚ï¼šv2.0.0'
        required: false
        default: 'manual-build'
        type: string
      release_notes:
        description: 'æ›´æ–°è¯´æ˜Ž (æ”¯æŒå¤šè¡Œï¼Œä½¿ç”¨ | åˆ†éš”ä¸åŒè¡Œ)'
        required: false
        default: ''
        type: string

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include:
          # x86_64
          - platform: linux/amd64
            arch: x86_64
            target_name: x86_64-linux-musl@generic
            
          # x86 32-bit
          - platform: linux/386
            arch: i386
            target_name: i386-linux-musl@i686
            
          # ARM64 v8
          - platform: linux/arm64/v8
            arch: aarch64
            target_name: aarch64-linux-musl@generic+v8a
            
          # ARM32 v7
          - platform: linux/arm/v7
            arch: armv7
            target_name: arm-linux-musleabihf@generic+v7a
            
          # ARM32 v6
          - platform: linux/arm/v6
            arch: armv6
            target_name: arm-linux-musleabi@generic+v6+soft_float

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build in Alpine container
      run: |
        # åˆ›å»ºæž„å»ºè„šæœ¬
        cat > build.sh << 'SCRIPT'
        #!/bin/sh
        set -e
        
        # å®‰è£…æž„å»ºä¾èµ–
        apk add --no-cache build-base openssl-dev openssl-libs-static linux-headers
        
        # æ˜¾ç¤ºçŽ¯å¢ƒä¿¡æ¯
        echo "Architecture: $(uname -m)"
        echo "GCC version: $(gcc --version | head -n1)"
        echo "OpenSSL version: $(openssl version)"
        
        # æ¸…ç†
        make clean || true
        
        # åˆ›å»ºé™æ€é“¾æŽ¥çš„ Makefile
        cat > Makefile.static << 'EOF'
        CC = gcc
        CFLAGS = -std=c99 -Wall -Wextra -O3 -DNDEBUG -ffunction-sections -fdata-sections
        LDFLAGS = -static -Wl,--gc-sections
        LIBS = -lssl -lcrypto -lz -ldl -lpthread -lm
        
        SRCS = dns2tcp-plus.c libev/ev.c
        OBJS = $(SRCS:.c=.o)
        MAIN = dns2tcp-plus
        
        all: $(MAIN)
        
        $(MAIN): $(OBJS)
        	$(CC) $(LDFLAGS) -o $(MAIN) $(OBJS) $(LIBS)
        
        dns2tcp-plus.o: dns2tcp-plus.c
        	$(CC) $(CFLAGS) -c dns2tcp-plus.c -o dns2tcp-plus.o
        
        libev/ev.o: libev/ev.c
        	$(CC) $(CFLAGS) -DEV_STANDALONE=1 -c libev/ev.c -o libev/ev.o
        
        clean:
        	$(RM) $(MAIN) $(OBJS)
        EOF
        
        # ç¼–è¯‘
        make -f Makefile.static
        
        # Strip ä¼˜åŒ–å¤§å°
        strip -s dns2tcp-plus
        
        # æ£€æŸ¥æ–‡ä»¶
        echo "=== File info ==="
        file dns2tcp-plus
        ls -la dns2tcp-plus
        
        # æ£€æŸ¥æ˜¯å¦é™æ€é“¾æŽ¥
        echo "=== Checking static linking ==="
        if ldd dns2tcp-plus 2>&1 | grep -q "not a dynamic executable"; then
          echo "âœ“ Binary is statically linked"
        else
          echo "âœ— Warning: Binary may not be fully static"
          ldd dns2tcp-plus || true
        fi
        
        # æµ‹è¯•è¿è¡Œ
        echo "=== Testing binary ==="
        ./dns2tcp-plus -V || echo "Version check failed (may be normal for cross-compiled binaries)"
        SCRIPT
        
        chmod +x build.sh
        
        # ä½¿ç”¨ Docker åœ¨å¯¹åº”æž¶æž„çš„ Alpine å®¹å™¨ä¸­æž„å»º
        docker run --rm \
          --platform=${{ matrix.platform }} \
          -v "$PWD:/work" \
          -w /work \
          alpine:3.19 \
          sh -c './build.sh'
        
        # é‡å‘½åè¾“å‡ºæ–‡ä»¶
        mv dns2tcp-plus dns2tcp-plus@${{ matrix.target_name }}

    - name: Compress with UPX (optional)
      continue-on-error: true
      run: |
        # å®‰è£… UPX
        wget -q https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-amd64_linux.tar.xz
        tar xf upx-4.2.2-amd64_linux.tar.xz
        
        # å¤‡ä»½åŽŸå§‹æ–‡ä»¶
        cp dns2tcp-plus@${{ matrix.target_name }} dns2tcp-plus@${{ matrix.target_name }}.orig
        
        # å°è¯•åŽ‹ç¼©ï¼ˆæŸäº›æž¶æž„å¯èƒ½ä¸æ”¯æŒï¼‰
        if ./upx-4.2.2-amd64_linux/upx --best --lzma dns2tcp-plus@${{ matrix.target_name }}; then
          echo "UPX compression successful"
          ls -la dns2tcp-plus@${{ matrix.target_name }}*
        else
          echo "UPX compression failed, using original"
          mv dns2tcp-plus@${{ matrix.target_name }}.orig dns2tcp-plus@${{ matrix.target_name }}
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dns2tcp-plus@${{ matrix.target_name }}
        path: dns2tcp-plus@${{ matrix.target_name }}

  # ä¸ºæ—§ç‰ˆ ARM è®¾å¤‡æž„å»ºé¢å¤–ç‰ˆæœ¬
  build-legacy-arm:
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/arm/v5
            target_name: arm-linux-musleabi@generic+v5t+soft_float
          - platform: linux/arm/v5
            target_name: arm-linux-musleabi@generic+v5te+soft_float

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Build in Alpine container
      run: |
        # ä½¿ç”¨ç›¸åŒçš„æž„å»ºè„šæœ¬
        cat > build.sh << 'SCRIPT'
        #!/bin/sh
        set -e
        apk add --no-cache build-base openssl-dev openssl-libs-static linux-headers
        
        cat > Makefile.static << 'EOF'
        CC = gcc
        CFLAGS = -std=c99 -Wall -Wextra -O2 -DNDEBUG -march=armv5t -msoft-float
        LDFLAGS = -static
        LIBS = -lssl -lcrypto -lz -ldl -lpthread -lm
        
        SRCS = dns2tcp-plus.c libev/ev.c
        OBJS = $(SRCS:.c=.o)
        MAIN = dns2tcp-plus
        
        all: $(MAIN)
        
        $(MAIN): $(OBJS)
        	$(CC) $(LDFLAGS) -o $(MAIN) $(OBJS) $(LIBS)
        
        .c.o:
        	$(CC) $(CFLAGS) -c $< -o $@
        
        libev/ev.o: libev/ev.c
        	$(CC) $(CFLAGS) -DEV_STANDALONE=1 -c libev/ev.c -o libev/ev.o
        
        clean:
        	$(RM) $(MAIN) $(OBJS)
        EOF
        
        make -f Makefile.static
        strip -s dns2tcp-plus
        
        file dns2tcp-plus
        ls -la dns2tcp-plus
        SCRIPT
        
        chmod +x build.sh
        
        docker run --rm \
          --platform=${{ matrix.platform }} \
          -v "$PWD:/work" \
          -w /work \
          alpine:3.19 \
          sh -c './build.sh' || echo "Build failed for ${{ matrix.platform }}"
        
        if [ -f dns2tcp-plus ]; then
          mv dns2tcp-plus dns2tcp-plus@${{ matrix.target_name }}
        else
          echo "No binary produced for ${{ matrix.target_name }}"
          # åˆ›å»ºä¸€ä¸ªå ä½æ–‡ä»¶
          echo "Build failed" > dns2tcp-plus@${{ matrix.target_name }}
        fi

    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dns2tcp-plus@${{ matrix.target_name }}
        path: dns2tcp-plus@${{ matrix.target_name }}

  release:
    needs: [build, build-legacy-arm]
    runs-on: ubuntu-latest
    if: always() && (startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        merge-multiple: true

    - name: Check and filter artifacts
      run: |
        # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
        ls -la dns2tcp-plus@*
        
        # è¿‡æ»¤æŽ‰å¤±è´¥çš„æž„å»ºï¼ˆæ–‡æœ¬æ–‡ä»¶ï¼‰
        for f in dns2tcp-plus@*; do
          if file "$f" | grep -q "text"; then
            echo "Removing failed build: $f"
            rm "$f"
          fi
        done
        
        # æ˜¾ç¤ºæœ€ç»ˆçš„æ–‡ä»¶åˆ—è¡¨
        echo "=== Final binaries ==="
        ls -la dns2tcp-plus@* || echo "No binaries found!"
        
        # ç”Ÿæˆ SHA256 æ ¡éªŒå’Œ
        if ls dns2tcp-plus@* 1> /dev/null 2>&1; then
          sha256sum dns2tcp-plus@* > sha256sums.txt
          cat sha256sums.txt
        fi

    - name: Set release info
      id: release_info
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
          RELEASE_NOTES_RAW="${{ github.event.inputs.release_notes }}"
        else
          VERSION="${{ github.ref_name }}"
          RELEASE_NOTES_RAW=""
        fi
        
        if [ -z "$VERSION" ] || [ "$VERSION" = "manual-build" ]; then
          VERSION="${{ github.ref_name }}"
        fi
        
        RELEASE_NOTES=$(echo "$RELEASE_NOTES_RAW" | sed 's/ | /\n/g' | sed 's/|/\n/g')
        
        if [ -z "$RELEASE_NOTES" ]; then
          RELEASE_NOTES="# dns2tcp-plus $VERSION

## ðŸ†• ä¸»è¦ç‰¹æ€§ / Major Features

- ðŸ”’ **DNS over TLS (DoT)** - 853ç«¯å£è‡ªåŠ¨åŠ å¯† / Automatic encryption on port 853
- ðŸ”„ **ç³»ç»ŸDNSé›†æˆ** - æ™ºèƒ½æ•…éšœè½¬ç§» / System DNS with smart failover
- âš¡ **å†…å­˜æ± ä¼˜åŒ–** - é«˜æ€§èƒ½è®¾è®¡ / Memory pool optimization
- ðŸ›¡ï¸ **å®‰å…¨å¢žå¼º** - æ¶æ„IPè¿‡æ»¤ / Enhanced security features

## ðŸ“¦ ä¸‹è½½è¯´æ˜Ž / Download Guide

æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶éƒ½æ˜¯é™æ€é“¾æŽ¥ï¼Œå¯åœ¨ç›¸åº”å¹³å°ç›´æŽ¥è¿è¡Œã€‚
All binaries are statically linked and ready to run.

### Intel/AMD
- \`x86_64-linux-musl\` - 64ä½ç³»ç»Ÿ / 64-bit systems
- \`i386-linux-musl\` - 32ä½ç³»ç»Ÿ / 32-bit systems

### ARM  
- \`aarch64-linux-musl\` - 64ä½ARM (æ ‘èŽ“æ´¾4/5) / 64-bit ARM (RPi 4/5)
- \`arm-linux-musleabihf@v7a\` - 32ä½ARM (æ ‘èŽ“æ´¾2/3) / 32-bit ARM (RPi 2/3)
- \`arm-linux-musleabi@v6\` - æ—§ç‰ˆARM (æ ‘èŽ“æ´¾1) / Older ARM (RPi 1)
- \`arm-linux-musleabi@v5t\` - æ›´æ—§è®¾å¤‡ / Legacy devices

## ðŸ“ SHA256 æ ¡éªŒå’Œ / Checksums

è¯·ä¸‹è½½ \`sha256sums.txt\` éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ã€‚
Download \`sha256sums.txt\` to verify file integrity."
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "release_notes<<EOF" >> $GITHUB_OUTPUT
        echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.release_info.outputs.version }}
        name: dns2tcp-plus ${{ steps.release_info.outputs.version }}
        body: ${{ steps.release_info.outputs.release_notes }}
        files: |
          dns2tcp-plus@*
          sha256sums.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
